<!DOCTYPE html>
<html lang="cs">
    <body>
    <h2>Evidenƒçn√≠ syst√©m v√Ωmƒõn√≠k≈Ø</h2>
    <button onclick="openAddCustomerModal()">P≈ôidat z√°kazn√≠ka</button>
    <button onclick="openAddExchangerModal()">P≈ôidat v√Ωmƒõn√≠k</button>
    <!-- Z√°kazn√≠ci -->
    <h3>Seznam z√°kazn√≠k≈Ø</h3>
    <table>
        <thead>
            <tr>
                <th></th>
                <th>ƒå√≠slo</th>
                <th>N√°zev firmy</th>
                <th>Mƒõsto</th>
                <th>Ulice</th>
                <th>IƒåO</th>
                <th>Kontaktn√≠ osoba</th>
                <th>Telefon</th>
                <th>E-mail</th>
            </tr>
        </thead>
        <tbody id="customers-body"></tbody>
    </table>


    <!-- Mod√°ln√≠ okno pro p≈ôid√°n√≠ z√°kazn√≠ka -->
    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCustomerModal')">&times;</span>
            <h3>P≈ôidat z√°kazn√≠ka</h3>
            <form onsubmit="submitCustomerForm(); return false;">
                <label for="customerID">ID z√°kazn√≠ka:</label><br>
                <input type="text" id="customerID"><br>
                <label for="customerName">N√°zev firmy:</label><br>
                <input type="text" id="customerName"><br>
                <label for="customerCity">Mƒõsto:</label><br>
                <input type="text" id="customerCity"><br>
                <label for="customerStreet">Ulice:</label><br>
                <input type="text" id="customerStreet"><br>
                <label for="customerIco">IƒåO:</label><br>
                <input type="text" id="customerIco"><br>
                <label for="customerContact">Kontaktn√≠ osoba:</label><br>
                <input type="text" id="customerContact"><br>
                <label for="customerPhone">Telefon:</label><br>
                <input type="text" id="customerPhone"><br>
                <label for="customerEmail">E-mail:</label><br>
                <input type="email" id="customerEmail"><br>
                <button type="submit">P≈ôidat</button>
            </form>
        </div>
    </div>

    <!-- Mod√°ln√≠ okno pro p≈ôid√°n√≠ v√Ωmƒõn√≠ku -->
    <div id="addExchangerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addExchangerModal')">&times;</span>
            <h3>P≈ôidat v√Ωmƒõn√≠k</h3>
            <form onsubmit="submitExchangerForm(event); return false;">
                <label for="exchangerCustomer">Z√°kazn√≠k:</label><br>
                <select id="exchangerCustomer"></select><br>
                <label for="exchangerRegNumber">Registraƒçn√≠ ƒç√≠slo:</label><br>
                <input type="text" id="exchangerRegNumber"><br>
                <label for="exchangerManufacturer">V√Ωrobce:</label><br>
                <input type="text" id="exchangerManufacturer"><br>
                <label for="exchangerType">Typ:</label><br>
                <input type="text" id="exchangerType"><br>
                <label for="exchangerProdNumber">V√Ωrobn√≠ ƒç√≠slo:</label><br>
                <input type="text" id="exchangerProdNumber"><br>
                <label for="exchangerProdDate">Datum v√Ωroby:</label><br>
                <input type="date" id="exchangerProdDate"><br>
                <label for="exchangerHeatCarrier">Teplonosn√° l√°tka:</label><br>
                <input type="text" id="exchangerHeatCarrier"><br>
                <label for="exchangerLocation">Poloha:</label><br>
                <input type="text" id="exchangerLocation"><br>
                <label for="exchangerCheckInterval">Interval kontroly:</label><br>
                <input type="text" id="exchangerCheckInterval"><br>
                <label for="exchangerLastCheckDate">Datum posledn√≠ kontroly:</label><br>
                <input type="date" id="exchangerLastCheckDate"><br>
                <label for="exchangerNextCheckDate">Datum pl√°novan√© kontroly:</label><br>
                <input type="date" id="exchangerNextCheckDate"><br>
                <label for="exchangerNote">Pozn√°mka:</label><br>
                <input type="text" id="exchangerNote"><br>
                <button type="submit">P≈ôidat</button>
            </form>
        </div>
    </div>
</body>
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidenƒçn√≠ syst√©m v√Ωmƒõn√≠k≈Ø</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { setDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

       
        // Inicializace Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD6KR6-j_ouZz9pZ7X1hbKDPpBYanP6qUs",
            authDomain: "test3-a06c4.firebaseapp.com",
            projectId: "test3-a06c4",
            storageBucket: "test3-a06c4.appspot.com",
            messagingSenderId: "982762948421",
            appId: "1:982762948421:web:56e67c73d435c0e00fa02c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Funkce pro naƒçten√≠ z√°kazn√≠k≈Ø
        
       async function loadCustomers() {
           const customersCol = collection(db, "customers");
           const customerSnapshot = await getDocs(customersCol);
           const customersList = customerSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
           displayCustomers(customersList);
       }

       // Funkce pro zobrazen√≠ z√°kazn√≠k≈Ø
       function displayCustomers(customers) {
           const tableBody = document.getElementById("customers-body");
           tableBody.innerHTML = ''; // Vymaz√°n√≠ star√Ωch dat
           customers.forEach((customer) => {
               const row = document.createElement("tr");
               row.innerHTML = `
                   <td><button class="toggle-btn" data-customerid="${customer.id}" onclick="toggleExchangers('${customer.id}')">‚ñº</button></td>
                   <td class="no-edit">${customer.customerID}</td>
                   <td data-id="${customer.id}" data-field="name">${customer.name}</td>
                   <td data-id="${customer.id}" data-field="city">${customer.city}</td>
                   <td data-id="${customer.id}" data-field="street">${customer.street}</td>
                   <td class="no-edit">${customer.ico}</td>
                   <td data-id="${customer.id}" data-field="contactPerson">${customer.contactPerson}</td>
                   <td data-id="${customer.id}" data-field="phone">${customer.phone}</td>
                   <td data-id="${customer.id}" data-field="email">${customer.email}</td>
               `;
               tableBody.appendChild(row);

               // P≈ôid√°n√≠ ≈ô√°dku pro v√Ωmƒõn√≠ky
               const exchangersRow = document.createElement("tr");
               exchangersRow.id = `exchangers-${customer.id}-container`;
               exchangersRow.style.display = "none"; // Skr√Ωt v√Ωmƒõn√≠ky na zaƒç√°tku
               const exchangersCell = document.createElement("td");
               exchangersCell.colSpan = 10;
               exchangersCell.innerHTML = `
                   <table>
                       <thead>
                           <tr>
                               <th class="no-edit">Registraƒçn√≠ ƒç√≠slo</th>
                               <th>V√Ωrobce</th>
                               <th>Typ</th>
                               <th>V√Ωrobn√≠ ƒç√≠slo</th>
                               <th>Datum v√Ωroby</th>
                               <th>Teplonosn√° l√°tka</th>
                               <th>Poloha</th>
                               <th>Interval kontroly</th>
                               <th>Datum posledn√≠ kontroly</th>
                               <th>Datum pl√°novan√© kontroly</th>
                               <th>Pozn√°mka</th>
                               <th>QR k√≥d</th>
                           </tr>
                       </thead>
                       <tbody id="exchangers-${customer.id}-body"></tbody>
                   </table>
               `;
               exchangersRow.appendChild(exchangersCell);
               tableBody.appendChild(exchangersRow);

               // Naƒçten√≠ v√Ωmƒõn√≠k≈Ø pro konkr√©tn√≠ho z√°kazn√≠ka
               loadExchangers(customer.id);
           });
       }

       // Funkce pro naƒçten√≠ v√Ωmƒõn√≠k≈Ø pro konkr√©tn√≠ho z√°kazn√≠ka
       async function loadExchangers(customerId) {
           const exchangersCol = collection(db, "customers", customerId, "exchangers");
           const exchangersSnapshot = await getDocs(exchangersCol);
           const exchangersList = exchangersSnapshot.docs.map(doc => doc.data());
           displayExchangers(exchangersList, customerId);
       }

       // Funkce pro zobrazen√≠ v√Ωmƒõn√≠k≈Ø
       function displayExchangers(exchangers, customerId) {
           const tableBody = document.getElementById(`exchangers-${customerId}-body`);
           tableBody.innerHTML = ''; // Vymaz√°n√≠ star√Ωch dat
           exchangers.forEach((exchanger) => {
               const row = document.createElement("tr");
               row.innerHTML = `
                   <td class="no-edit">${exchanger.registrationNumber}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="manufacturer">${exchanger.manufacturer}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="type">${exchanger.type}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="productionNumber">${exchanger.productionNumber}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="productionDate">${exchanger.productionDate}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="heatCarrier">${exchanger.heatCarrier}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="location">${exchanger.location}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="checkInterval">${exchanger.checkInterval}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="lastCheckDate">${exchanger.lastCheckDate}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="nextCheckDate">${exchanger.nextCheckDate}</td>
                   <td data-id="${exchanger.registrationNumber}" data-field="note">${exchanger.note}</td>
                   <td><div class="qr-code-container" data-reg="${exchanger.registrationNumber}"></div></td>
               `;
               tableBody.appendChild(row);

               // Generov√°n√≠ QR k√≥du pro v√Ωmƒõn√≠k
               const qrContainer = document.querySelector(`.qr-code-container[data-reg="${exchanger.registrationNumber}"]`);
               QRCode.toDataURL(exchanger.registrationNumber) // Generov√°n√≠ QR k√≥du na z√°kladƒõ registraƒçn√≠ho ƒç√≠sla
                   .then((url) => {
                       const img = document.createElement("img");
                       img.src = url;
                       img.alt = `QR k√≥d pro ${exchanger.registrationNumber}`;
                       img.style.width = "50px"; // Nastaven√≠ velikosti obr√°zku
                       qrContainer.appendChild(img);
                   })
                   .catch((error) => {
                       console.error("Chyba p≈ôi generov√°n√≠ QR k√≥du:", error);
                   });
           });
       }

       // Naƒçten√≠ dat po naƒçten√≠ str√°nky
       window.onload = function() {
           loadCustomers();
       };
      

        // Funkce pro p≈ôep√≠n√°n√≠ zobrazen√≠ v√Ωmƒõn√≠k≈Ø
        window.toggleExchangers = function(customerID) {
            const exchangersRow = document.getElementById(`exchangers-${customerID}-container`);
            console.log(`Hled√°m ID: exchangers-${customerID}`, exchangersRow);
            if (!exchangersRow) {
                console.error(`Chyba: Element s ID 'exchangers-${customerID}-container' nebyl nalezen.`);
                return;
            }
            const button = document.querySelector(`button.toggle-btn[data-customerid="${customerID}"]`);
            if (!button) {
                console.error(`Chyba: Tlaƒç√≠tko s data-customerid '${customerID}' nebylo nalezeno.`);
                return;
            }

            if (exchangersRow.style.display === "none") {
                exchangersRow.style.display = "table-row";
                button.innerHTML = "‚ñ≤"; // Nahrazen√≠ ≈°ipky dol≈Ø ≈°ipkou nahoru
            } else {
                exchangersRow.style.display = "none";
                button.innerHTML = "‚ñº"; // Nahrazen√≠ ≈°ipky nahoru ≈°ipkou dol≈Ø
            }
        };

        // Funkce pro zobrazen√≠ mod√°ln√≠ho okna pro p≈ôid√°n√≠ z√°kazn√≠ka
        window.openAddCustomerModal = function() {
            document.getElementById("addCustomerModal").style.display = "block";
        }

        // Funkce pro vypr√°zdnƒõn√≠ formul√°≈ôe
        function clearExchangerForm() {
            document.getElementById("exchangerRegNumber").value = "";
            document.getElementById("exchangerManufacturer").value = "";
            document.getElementById("exchangerType").value = "";
            document.getElementById("exchangerProdNumber").value = "";
            document.getElementById("exchangerProdDate").value = "";
            document.getElementById("exchangerHeatCarrier").value = "";
            document.getElementById("exchangerLocation").value = "";
            document.getElementById("exchangerCheckInterval").value = "";
            document.getElementById("exchangerLastCheckDate").value = "";
            document.getElementById("exchangerNextCheckDate").value = "";
        }
        // Funkce pro zobrazen√≠ mod√°ln√≠ho okna pro p≈ôid√°n√≠ v√Ωmƒõn√≠ku
        window.openAddExchangerModal = function() {
            document.getElementById("addExchangerModal").style.display = "block";
        }

        // Funkce pro zav≈ôen√≠ mod√°ln√≠ho okna
        window.closeModal = function(modalId) {
            clearExchangerForm();
            document.getElementById(modalId).style.display = "none";
        }

        // Funkce pro odesl√°n√≠ formul√°≈ôe z√°kazn√≠ka
        window.submitCustomerForm = function() {
            const customerData = {
                customerID: document.getElementById("customerID").value,
                name: document.getElementById("customerName").value,
                city: document.getElementById("customerCity").value,
                street: document.getElementById("customerStreet").value,
                ico: document.getElementById("customerIco").value,
                contactPerson: document.getElementById("customerContact").value,
                phone: document.getElementById("customerPhone").value,
                email: document.getElementById("customerEmail").value,
            };
            addCustomer(customerData);
            closeModal('addCustomerModal');
        };
        
        // Funkce pro odesl√°n√≠ formul√°≈ôe v√Ωmƒõn√≠ku
          window.submitExchangerForm = async function(event) {
              if (event) event.preventDefault(); // Zabr√°n√≠me odesl√°n√≠ formul√°≈ôe
              const customerId = document.getElementById("exchangerCustomer").value;
              if (!customerId) {
                  console.error("Chyba: customerId nen√≠ vybr√°n!");
                  return;
              }
              // Shrom√°≈ædƒõn√≠ dat z formul√°≈ôe
              const exchangerData = {
                  registrationNumber: document.getElementById("exchangerRegNumber").value,
                  manufacturer: document.getElementById("exchangerManufacturer").value,
                  type: document.getElementById("exchangerType").value,
                  productionNumber: document.getElementById("exchangerProdNumber").value,
                  productionDate: document.getElementById("exchangerProdDate").value,
                  heatCarrier: document.getElementById("exchangerHeatCarrier").value,
                  location: document.getElementById("exchangerLocation").value,
                  checkInterval: document.getElementById("exchangerCheckInterval").value,
                  lastCheckDate: document.getElementById("exchangerLastCheckDate").value,
                  nextCheckDate: document.getElementById("exchangerNextCheckDate").value,
                  note: document.getElementById("exchangerNote").value
              };
              if (!exchangerData.registrationNumber) {
                  alert("Registraƒçn√≠ ƒç√≠slo mus√≠ b√Ωt vyplnƒõno!");
                  return;
              }
              try {
                  // Ulo≈æ√≠me v√Ωmƒõn√≠k do datab√°ze
                  await setDoc(doc(db, "customers", customerId, "exchangers", exchangerData.registrationNumber), exchangerData);
                  alert("V√Ωmƒõn√≠k √∫spƒõ≈°nƒõ p≈ôid√°n!");
                  closeModal("addExchangerModal"); // Zav≈ôen√≠ mod√°ln√≠ho okna po p≈ôid√°n√≠
                  loadCustomers(); // Znovu naƒçteme z√°kazn√≠ky, aby se aktualizovala tabulka
              } catch (error) {
                  console.error("Chyba p≈ôi p≈ôid√°v√°n√≠ v√Ωmƒõn√≠ku:", error);
              }
          }; // Zde je uzav≈ôen√≠ funkce      

        // Funkce pro editaci bu≈àky po dvojkliku
         document.addEventListener("DOMContentLoaded", function () {
             document.querySelectorAll("table").forEach(table => {
                 table.addEventListener("dblclick", async function (event) {
                     let target = event.target;

                     // Pokud je bu≈àka oznaƒçen√° jako no-edit, neudƒõl√°me nic
                     if (target.tagName === "TD" && !target.classList.contains("no-edit")) {
                         let originalText = target.innerText;
                         let newText = prompt("Upravte hodnotu:", originalText);

                         if (newText !== null && newText !== originalText) {
                             target.innerText = newText;

                             // Z√≠sk√°n√≠ ID a pole, kter√© editujeme
                             let id = target.getAttribute("data-id"); // ID z√°kazn√≠ka nebo v√Ωmƒõn√≠ku
                             let field = target.getAttribute("data-field"); // N√°zev pole k √∫pravƒõ
                             let row = target.closest("tr"); // Najdeme ≈ô√°dek, ve kter√©m se bu≈àka nach√°z√≠
                             let customerID = row ? row.getAttribute("data-customerid") : null; // ID z√°kazn√≠ka
                             let registrationNumber = target.getAttribute("data-exchangerid"); // ID v√Ωmƒõn√≠ku

                             try {
                                 if (registrationNumber) {
                                     // üîπ Upravujeme v√Ωmƒõn√≠k (je ulo≈æen pod z√°kazn√≠kem)
                                     const docRef = doc(db, "customers", customerID);
                                     await updateDoc(docRef, {
                                         [`exchangers.${registrationNumber}.${field}`]: newText
                                     });

                                     console.log(`‚úÖ √öspƒõ≈°nƒõ aktualizov√°no: v√Ωmƒõn√≠k ${registrationNumber}`);
                                 } else {
                                     // üîπ Upravujeme z√°kazn√≠ka (p≈Øvodn√≠ funkƒçnost)
                                     const docRef = doc(db, "customers", id);
                                     await updateDoc(docRef, { [field]: newText });

                                     console.log(`‚úÖ √öspƒõ≈°nƒõ aktualizov√°no: z√°kazn√≠k ${id}`);
                                 }
                             } catch (error) {
                                 alert("‚ùå Chyba p≈ôi ukl√°d√°n√≠ do Firestore.");
                                 console.error("Chyba:", error);
                                 target.innerText = originalText; // Pokud dojde k chybƒõ, vr√°t√≠me starou hodnotu
                             }
                         }
                     }
                 });
             });
         });
        
    </script>
 <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .toggle-btn {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }

        /* Styly pro mod√°ln√≠ okna */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    
</head>

</html>
